<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>CNC GRBL Carver</title>
		<meta name="description" content="IELTS WRITING TASK 1">
		<style>
			body {
				background: rgb(20, 22, 11);
				font-family: "Consolas";
				font-weight: 300;
				font-size: 14px;
				text-align: left;
				color: rgb(209, 216, 243);
			}
			h1 {
				text-align: left;
				color: rgb(251, 251, 251);
			}
			h3 {
				font-style: oblique;
				color: rgb(86, 255, 134);
			}
			.framy {
				background: rgb(24, 29, 34);
				padding: 10px;
				font-size: 14px;
				margin: 10px 200px;
				border: 2px;
				display:inline-block;
				text-align: left;
			}
			.styled4 {
				border: 0;
				font: "Consolas";
				line-height: 2.5;
				font-weight: 300;
				padding: 5px 30px;
				font-size: 1rem;
				text-align: center;
				color: #fff;
				text-shadow: 1px 1px 1px #000;
				border-radius: 10px;
				background-color: rgb(47, 162, 76);
				background-image: linear-gradient(to top left,
												rgba(0, 0, 0, .2),
												rgba(0, 0, 0, .2) 30%,
												rgba(0, 0, 0, 0));
				box-shadow: inset 2px 2px 3px rgba(255, 255, 255, .6),
							inset -2px -2px 3px rgba(0, 0, 0, .6);
			}

			.styled4:hover {
				background-color: rgb(165, 0, 220);
			}

			.styled4:active {
				box-shadow: inset -2px -2px 3px rgba(255, 255, 255, .6),
							inset 2px 2px 3px rgba(0, 0, 0, .6);
			}
			input[type="file"] {
				display: none;
			}
			input[type="text"] {
				width: 100px;
			}
			div {
				display: inline-block;
				vertical-align: top;
			}
		</style>
	</head>
	<body>
	<h1>GRBL G-Code converter</h1>
	<p>Author: Herbert Alexis Caller Guzman</p>
	<p>(Under Work, use with caution)</p>
	<p>
		This tool modifies the g-code exported with LaserGRBL.</br>
		The modified g-code has additonal steps to carve wood using a z-axis ramp of 0.5mm.</br>
		This tool does not generate optimized toolpaths.</br>
		It will be optimized in one of the axis used to export the file.</br>
		My usual setting is a feed rate of F3000 and a speed of S500 for small projects (similar to a sheet of A5 or A4 paper).</br>
		Commonplace spindles for grbl have a maximum speed of S1000.
	</p>
	<p>Usage: Wood engraving, woodcut, relief printing</p>
	<p>
		The deep of the groove is the number of passes times the z-axis ramp.
	</p>
	<hr>
	<label for="zramp">Z-Axis ramp (mm):&emsp13;</label><input type="text" id="zramp" name="zramp" value="0.5"><br>
	<label for="speed">Spindle Speed (S0-S1000):&emsp13;</label><input type="text" id="speed" name="speed" value="S500"><br>
	<label for="power">Laser Power (S0-S1000):&emsp13;</label><input type="text" id="power" name="power" value="S200"><br>
	<!--label for="powerth">Laser Power Threshold (S0-S1000):&emsp13;</label><input type="text" id="powerth" name="powerth" value="S20"><br-->
	<p>Select preferred axis</p>
	<div>
	<input type="radio" id="yaxis" name="axis" value="yaxis"checked>
	<label for="yaxis">Y-Axis</label>
	</div>
	<div>
	<input type="radio" id="xaxis" name="axis" value="xaxis">
	<label for="xaxis">X-Axis</label>
	</div>
	<hr>
	<div>
		<h2 >Paste G-Code exported with LaserGRBL</h2></br>
		<textarea id="task" name="task" rows="20" cols="100"></textarea>
		</br>
		<button class="styled4" type="button" id="loadgcode">Convert</button>
		<button class="styled4" type="button" id="clear">Clear</button>
	</div>
	<div>
		<hr style="background-color: yellowgreen; width: 1px; height: 500px; padding: 1px; margin: 10px 50px">
	</div>
	<div>
		<h2>G-Code modified for carving</h2></br>
		<textarea id="result" name="result" rows="20" cols="100"></textarea>
	</br>
	<button class="styled4" type="button" id="copycode">Copy</button>
	<!--button class="styled4" type="button" id="savecode">Save</button-->
	<div class="styled4"><a href="" id="disk" style="color:white">Save</a></div>
	</div>
	<hr>
	</body>
	<script>
		//var gcode;
		var task = document.getElementById("task");
		var result = document.getElementById("result");
		var loadgcode = document.getElementById("loadgcode");
		var copycode = document.getElementById("copycode");
		//var savecode = document.getElementById("savecode");
		var disk = document.getElementById("disk");
		var clear = document.getElementById("clear");
		clear.addEventListener('click', event => {
			task.value = "";
			result.value = "";
		});
		//savecode.addEventListener('click', event => {});
		loadgcode.addEventListener('click', event => {
			var gcode = task.value;
			console.log("Loaded!");
			result.value = analizeLines(gcode);
			// save file locally
			localStorage.setItem('samplenc', result.value);
			var file = new Blob([result.value], {type: 'text/plain'});
			disk.href = URL.createObjectURL(file);
			disk.download = 'sample.nc';
		});
		copycode.addEventListener('click', event => {
			result.select(); 
			document.execCommand("copy");
			console.log("Copied!");
		});
		function analizeLines(gcode) {
			var newGcode = "";
			var lines = gcode.split('\n');
			console.log(document.getElementById("zramp").value);
			var zStep = parseFloat(document.getElementById("zramp").value);
			console.log(document.getElementById("speed").value);
			var speed = document.getElementById("speed").value;
			sinkAction = false;
			for (var i = 1; i < lines.length; i++) {
				//console.log(lines[i]);
				if (lines[i].includes("M3")) {
					sinkAction = false;
					newGcode = newGcode + lines[i].replace(/S\d+/g,'S0') + "\n";
					//console.log("M3 detected");
				} else if (lines[i].includes("M5")) {
					sinkAction = false;
					newGcode = newGcode + lines[i] + "\n" + "G0 Z0"+ "\n" + "G4 P1" + "\n";
					//console.log("M5 detected");
				} else if (checkLaserOff(lines[i])) {
					// test dwell code
					newGcode = newGcode + "G0 Z0"+ "\n" + "G4 P1" + "\n";
					sinkAction = false;
					console.log("S0 detected");
				} else if (lines[i].includes("S")) {
					gline = lines[i].replace(/S\d+/g,'');
					//console.log(gline);
					if (analizeXYDistance(lines[i], lines[i-1])) {
						newGcode = newGcode + "G0 Z0"+ "\n" + "G4 P1" + "\n" + gline + "\n" +  "G0 Z" +  zStep + "\n";
						sinkAction = true;
						console.log("Laser noise detected");
					} else if (sinkAction) {
						newGcode = newGcode + gline + "\n"; 
					} else {
						newGcode = newGcode + gline + speed + "\n" +  "G0 Z" +  zStep + "\n";
						sinkAction = true;
					}
				} else if (lines[i].includes("sinks")) {
					zStep = zStep + 0.5;
				} else {
					newGcode = newGcode + lines[i] + "\n";
				}
			}
			return newGcode;
		}
		function analizeXYDistance(line1,line2) {
			var paxis = document.getElementsByName('axis');
			if (line1.includes("G1")){
				return false;
			} else {
				return analizeYDistance(line1,line2) || analizeXDistance(line1,line2);
			}
		}
		function analizeYDistance(line1,line2) {
			var out1 = line1.match(/Y(\d+\.?\d*)/);
			var out2 = line2.match(/Y(\d+\.?\d*)/);
			//console.log(out1,out2);
			if (out1 && out2) {
				var y1 = parseFloat(out1[1]);
				var y2 = parseFloat(out2[1]);
				if (Math.abs(y1 - y2) > 0.5) {
					return true;
				}
			}
			return false;
		}
		function analizeXDistance(line1,line2) {
			var out1 = line1.match(/X(\d+\.?\d*)/);
			var out2 = line2.match(/X(\d+\.?\d*)/);
			if (out1 && out2) {
				var y1 = parseFloat(out1[1]);
				var y2 = parseFloat(out2[1]);
				if (Math.abs(y1 - y2) > 0.5) {
					return true;
				}
			}
			return false;
		}
		function checkLaserPowerThreshold(line) {
			var out = line.match(/S(\d+)/);
			//console.log(out);
			var power = parseFloat(out[1]);
			var src = document.getElementById("power").value;
			var out = src.match(/S(\d+)/);
			//console.log(out);
			var psrc = parseFloat(out[1]);
			var thsrc = document.getElementById("powerth").value;
			var out = thsrc.match(/S(\d+)/);
			var pctPowerThreshold = parseFloat(out[1]);;
			//console.log(power,psrc);
			if (power < pctPowerThreshold) {
				return true;
			}
			return false;
		}
		function checkLaserOff(line) {
			var reX = /^S0/g;
			var x = line.match(reX)
			//console.log(x);
			if ( x != null && x[0] ===  "S0") {
				return true;
			}
			return false;
		}
	</script>
</html>